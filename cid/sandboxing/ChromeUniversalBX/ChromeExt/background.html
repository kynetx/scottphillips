<html>
<script src='jquery.js'></script>

<script>
var applications = {};
var domains_to_applications = {};
var user = {};
var errorstackkey = "f47b34280b996dfba66fd897f825c5b6";
var full_runtime = null;
var kynetx_account_server = "http://www.mykobj.net:3000";
var kynetx_runtime_url = "http://static.kobj.net/kobj-static-20101008193806.js";


var menu_items_for_apps = {};

window.localStorage.setItem("ken", "1286488357");

function errorStack(e) {
    var txt = "_s=" + errorstackkey + "&_r=json";
    txt += "&Msg=" + escape(e.message ? e.message : e);
    txt += "&ScriptURL=" + escape(e.fileName ? e.fileName : "Dynamic");
    txt += "&PageURL=" + escape(document.location.href);
    txt += "&Line=" + (e.lineNumber ? e.lineNumber : 0);
    txt += "&name=" + escape(e.name ? e.name : e);
    txt += "&Platform=" + escape(navigator.platform);
    txt += "&UserAgent=" + escape(navigator.userAgent);
    txt += "&stack=" + escape(e.stack ? e.stack : "Unknown Stack");
    aync_request("http://www.errorstack.com/submit?" + txt, "POST", function() {
    });
}


function flush_local_storage() {
    window.localStorage.clear();

}

/*
 This function is the message controller for the BX.  It response to a number of action and
 controls the flow of messages from the content pages to the background.
 */
chrome.extension.onRequest.addListener(message_responder);

var menu_items = {};

function process_current_menu(menus) {
    menu_items = {};
    chrome.contextMenus.removeAll();
    for (var app in menus) {
        var parent_id = chrome.contextMenus.create({title : app});

        for (var index in menus[app]) {
            var menu = menus[app][index];
            var menu_item = chrome.contextMenus.create({title : menu, parentId : parent_id,
                onclick : function(info, tab) {

                    chrome.windows.getCurrent(function(window) {
                        chrome.tabs.getSelected(window.id, function(tab) {
                            chrome.tabs.sendRequest(tab.id,
                            {action:"menu_clicked", "app_id":menu_items[info.menuItemId]["app_id"],
                                "caption" : menu_items[info.menuItemId]["caption"]});
                        });
                    });

                    chrome.tabs.get(tab.id).sendRequest({'action': "menu_clicked",
                        "app_id" : menu_items[info.menuItemId]["app_id"],
                        "caption" :  menu_items[info.menuItemId]["caption"]});
                }});

            menu_items[menu_item] = {app_id : app, caption : menu};
        }
    }
}


function message_responder(message, sender, sendResponse) {
    try {
        if (message.action == 'loadruntime') {

            if (!$.isEmptyObject(domains_to_applications)) {

                var apps_to_run = apps_to_execute(message.hostname);
                response_data = {runtime: full_runtime,
                    run_rule : true,
                    apps : apps_to_run,
                    eval_host : "cs.kobj.net",
                    callback_host : "log.kobj.net",
                    init_host : "init.kobj.net"
                };
                sendResponse(response_data);
            }
            else {
                sendResponse({run_rule : false});
            }
        }
        if (message.action == "refresh_menu") {
            process_current_menu(message.menu_items);
        }
        if (message.action == 'send_data') {
            send_data(message, sendResponse);
        }
        if (message.action == 'send_data_2') {
            sendResponse(sync_request_2(message.url, "GET"));
        }
        if (message.action == "login_success") {
            user = message.user;
            domains_to_applications = message.domains_to_applications;
            applications = message.applications;
        }
        if (message.action == "login_fail") {

        }
        if (message.action == "logout") {
            user = {};
            domains_to_applications = {};
            applications = {};
            window.localStorage.clear();
        }
        if (message.action == "reload_apps") {

        }
    }
    catch(e) {
        errorStack(e);
    }
}


function send_data(message, callback) {
    if (message.url.length < 1024) {
        async_request(message.url, "GET", callback);
    }
    else {
        async_request(message.url, "POST", callback);
    }
}

function split_post_data(url) {
    return {
        url: url.substring(0, url.indexOf("?", 0)),
        data: url.substring(url.indexOf("?", 0) + 1, url.length)
    };
}

function async_request(url, method, callback) {
    var req = new XMLHttpRequest();
    var data = null;
    if (method == "POST") {
        var result = split_post_data(url);
        url = result.url;
        data = result.data;
    }
    req.open(method, url, true);
    if (method == "POST") {
        req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

    }
    req.onreadystatechange = function (evt) {
        if (req.readyState == 4) {
            if (req.status == 200) {
                callback(req.responseText);
            }
        }
    };
    req.send(data);
}

function apps_to_execute(page_domain) {
    var apps = [];
    for (var domain in domains_to_applications) {
        var value = domains_to_applications[domain];

        var Kdomain = new RegExp(domain);
        if (page_domain.search(Kdomain) > -1) {
            apps = apps.concat(value)
        }
    }
    return apps;
}

function sync_request_2(url, method) {

    var data = null;
    // method = "POST";
    if (method == "POST") {
        var result = split_post_data(url);
        url = result.url;
        data = result.data;
    }
    var req = new XMLHttpRequest();
    req.open(method, url, false);
    if (method == "POST") {
        req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    }
    req.send(data);
    return req;
}

function sync_request(url, method) {

    var data = null;
    // method = "POST";
    if (method == "POST") {
        var result = split_post_data(url);
        url = result.url;
        data = result.data;
    }
    var req = new XMLHttpRequest();
    req.open(method, url, false);
    if (method == "POST") {
        req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    }
    req.send(data);
    return req.responseText;
}


function read_user_info() {
    // Go ask server for user info.  If the server decides what is right based on its knowledge of
    // the browser and user using cookies and such.
    var url = kynetx_account_server + "/users/get_user_info.json";
    if (window.localStorage.getItem("ken")) {
        url += "?ken=" + window.localStorage.getItem("ken");
    }
    $.ajax({
        type: "GET",
        url: url,
        dataType: "json",
        async: false,
        success: function(data) {
            user = data.user;
            domains_to_applications = data.domains_to_applications;
            applications = data.applications;
            window.localStorage.setItem("ken", data.ken_id);


        },
        error :function(data) {
            alert("error on request" + data);
        }
    });
}


try {
    full_runtime = sync_request(kynetx_runtime_url, "GET");
    read_user_info();
}
catch(e) {
    errorStack(e);
}


// Called when the user clicks on the browser action icon.
chrome.browserAction.onClicked.addListener(function(tab) {
    // We can only inject scripts to find the title on pages loaded with http
    // and https so for all other pages, we don't ask for the title.
    chrome.tabs.executeScript(null, {file: "content_script.js"});
});

chrome.extension.onConnect.addListener(function(port) {
    var tab = port.sender.tab;

    // This will get called by the content script we execute in
    // the tab as a result of the user pressing the browser action.
    port.onMessage.addListener(function(info) {
        chrome.windows.getCurrent(function(w) {
            parentWindowId = w.id;
            var width = 300;
            var height = 350;
            var left = (screen.width / 2) - (width / 2);
            var top = (screen.height / 2) - (height / 2);
            if (window.popUpWindow) {
                window.popUpWindow.close();
            }
            var options = 'width=' + width + ', height=' + height + ', top=' + top + ', left=' + left +
                    ", status=0, toolbar=0, location=0, menubar=0, resizable=1, scollbars=1, directories=0";
            window.popUpWindow = window.open(kynetx_account_server + "/users/show_login", "Kynetx Manager", options);
            window.popUpWindow.focus();
        });
    });
});


function load_tab_menus() {

    chrome.windows.getCurrent(function(window) {
        chrome.tabs.getSelected(window.id, function(tab) {

            if (tab.url != "chrome://extensions/") {
                chrome.tabs.executeScript(tab.id, {code : "try{updateMenu()}catch(e){}"});
                setTimeout(load_tab_menus, 1000);
            }
        });


    });
}

setTimeout(load_tab_menus, 1000);

</script>

<body>
My Background Page.
</body>
</html>