<!DOCTYPE HTML>
<script>
		safari.application.addEventListener("message",respondToMessage,false);		

		function load_sync_url_post(event)
		{
				var req = new XMLHttpRequest();
				req.open('GET', event.message.url, true);  
				console.log("have url " + event.message.url)
				req.onreadystatechange = function (aEvt) {  
					if (req.readyState == 4) {
					  if (req.status == 200) {
						
						console.log("done have url " + event.message.url)
						event.target.page.dispatchMessage("load_sync_url_response",
							{response : req.responseText, 
								callback: event.message.callback, 
								url: event.message.url, 
								params: event.message.params});
						
					  } else {
					  	throw "load url Error " + url;
					  }
					}
				};
				req.send(); 				
		}
	
	
	
		function respondToMessage(event) {
	    	switch(event.name) 
			{
				case "load_sync_url_post":
	       			load_sync_url_post(event);
				case "canLoad":
					var data = event.message
					if(data.element.nodeName  == "IFRAME")
					{
						event.message =  false;
					}
					event.message =  true;
			}
		}

	
</script>
